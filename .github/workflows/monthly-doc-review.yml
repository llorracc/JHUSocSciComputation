# Monthly documentation review: detect changes and optionally run an AI summary.
# Runs on the 1st of each month (9:00 UTC) and can be triggered manually (Actions > Monthly doc review > Run workflow).
# Optional: add OPENAI_API_KEY in repo Settings > Secrets to get an AI summary of changes in the issue.
name: Monthly doc review
on:
  schedule:
    # First day of every month at 9:00 UTC
    - cron: '0 9 1 * *'
  workflow_dispatch:
permissions:
  contents: read
  issues: write
jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Collect changes in last 30 days
        id: changes
        run: |
          SINCE="30 days ago"
          FILES=$(git log --since="$SINCE" --pretty=format: --name-only -- docs/ README.md myst.yml | sort -u | grep -v '^$' || true)
          COMMITS=$(git log --since="$SINCE" --oneline -- docs/ README.md myst.yml || true)
          DIFF=$(git diff "$(git rev-list -n1 --before="$SINCE" HEAD 2>/dev/null || git rev-list -n1 HEAD)" -- docs/ README.md myst.yml 2>/dev/null || echo "(no previous revision to diff)")
          printf '%s' "$DIFF" > doc-changes.diff
          echo "files<<EOOUTPUT" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOOUTPUT" >> $GITHUB_OUTPUT
          echo "commits<<EOOUTPUT" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOOUTPUT" >> $GITHUB_OUTPUT
          if [ -n "$FILES" ]; then echo "has_changes=true" >> $GITHUB_OUTPUT; else echo "has_changes=false" >> $GITHUB_OUTPUT; fi

      - name: Generate AI summary (optional)
        id: ai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ ! -s doc-changes.diff ] || [ -z "$OPENAI_API_KEY" ]; then
            echo "summary<<EOOUTPUT" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "EOOUTPUT" >> $GITHUB_OUTPUT
            exit 0
          fi
          BODY=$(node .github/scripts/monthly-doc-review.js < doc-changes.diff 2>/dev/null || echo "")
          echo "summary<<EOOUTPUT" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOOUTPUT" >> $GITHUB_OUTPUT

      - name: Create or update review issue
        env:
          GH_TOKEN: ${{ github.token }}
          FILES_BODY: ${{ steps.changes.outputs.files }}
          COMMITS_BODY: ${{ steps.changes.outputs.commits }}
          AI_BODY: ${{ steps.ai.outputs.summary }}
        run: |
          MONTH=$(date -u +%Y-%m)
          TITLE="Monthly doc review â€“ $MONTH"
          {
            echo "## Changes in the last 30 days"
            echo ""
            echo "**Files touched:**"
            echo '```'
            printf '%s\n' "$FILES_BODY"
            echo '```'
            echo ""
            echo "**Commits:**"
            echo '```'
            printf '%s\n' "$COMMITS_BODY"
            echo '```'
            echo ""
            printf '%s\n' "$AI_BODY"
            echo ""
            echo "---"
            echo "*Generated by the [Monthly doc review](https://github.com/${{ github.repository }}/actions/workflows/monthly-doc-review.yml) workflow. Run it manually from Actions > Monthly doc review.*"
          } > issue-body.md
          EXISTING=$(gh issue list --repo "${{ github.repository }}" --state open --search "in:title \"$TITLE\"" --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING" ]; then
            gh issue comment "$EXISTING" --body-file issue-body.md
          else
            gh issue create --title "$TITLE" --body-file issue-body.md
          fi
